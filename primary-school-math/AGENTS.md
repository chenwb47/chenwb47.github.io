# AGENTS.md - 小学数学知识可达矩阵分析系统

## 项目概述

这是一个面向小学1-3年级数学知识点的**可达矩阵分析系统**，采用图论中的传递闭包算法（Warshall算法）来分析知识点之间的依赖关系和可达性。

项目为纯前端单页应用（SPA），无需构建工具，直接在浏览器中运行。

### 核心功能

- **知识图谱可视化**：使用 D3.js 力导向图展示知识点及其前置依赖关系
- **年级筛选**：灵活选择显示 1-6 年级中的任意年级组合
- **可达矩阵计算**：基于 Warshall 算法计算传递闭包矩阵
- **可达性查询**：查询任意两个知识点之间是否存在学习路径
- **多源关联分析**：选择多个已掌握知识点，分析联合可达的新知识范围
- **掌握状态模拟**：模拟 1-6 年级的知识点掌握情况
- **响应式设计**：适配桌面端和移动端显示

## 技术栈

| 技术 | 用途 | 引入方式 |
|------|------|----------|
| **D3.js v7** | 力导向图可视化、交互 | CDN |
| **Tailwind CSS** | UI 样式框架 | CDN |
| **Google Fonts** | 中文字体（Noto Sans SC） | CDN |
| **原生 JavaScript** | 业务逻辑 | 本地 |

### 无构建工具

本项目**无构建流程**，无需 npm/yarn/webpack 等工具。直接在浏览器中打开 `index.html` 即可运行。

## 项目结构

```
kimiTest/
├── index.html          # 主页面入口，包含完整 UI 布局（248行）
├── app.js              # 核心逻辑（682行）：数据处理、图算法、可视化
├── styles.css          # 自定义样式：节点状态、动画效果（105行）
├── .gitignore          # Git 忽略规则
└── old-demo/           # 旧版本演示文件（已废弃）
    ├── 可达矩阵demo.html
    └── 可达矩阵demo - 副本 - 副本.html
```

### 文件职责

- **`index.html`**：三栏式布局（左侧控制面板、中间可视化、右侧矩阵）
- **`app.js`**：包含数据结构、Warshall算法、D3渲染、事件处理等所有逻辑
- **`styles.css`**：节点状态样式（已掌握/就绪/锁定）、连线动画、矩阵单元格效果

## 核心数据结构

### 知识点数据 (`knowledgeData`)

当前包含 **59 个核心知识点**：
| 年级 | 数量 | 主要知识点 |
|------|------|-----------|
| 一年级 | 6 个 | 数数、比大小、加减法、进位加、认识图形、认识钟表 |
| 二年级 | 6 个 | 乘法口诀、除法、长度单位、角的认识、观察物体、数据收集 |
| 三年级 | 18 个 | 万以内数、多位数运算、分数/小数初步、周长面积、时间、统计等 |
| 四年级 | 11 个 | 大数认识、三位数乘两位数、四则运算、运算定律、几何图形、统计 |
| 五年级 | 12 个 | 小数乘除法、简易方程、多边形面积、体积、因数倍数、概率初步 |
| 六年级 | 10 个 | 分数乘除法、比和比例、百分数、圆、圆柱圆锥、负数、鸽巢原理 |

```javascript
{
    "1-数数": { grade: 1, deps: [], desc: "10以内数的认识" },
    "2-乘法口诀": { grade: 2, deps: ["1-进位加"], desc: "表内乘法" },
    "3-分数初步": { grade: 3, deps: ["2-除法"], desc: "分数认识" }
}
```

- **ID 格式**：`{年级}-{知识点名称}`
- **grade**：所属年级（1/2/3）
- **deps**：前置依赖知识点 ID 数组
- **desc**：知识点描述

### 年级筛选逻辑

系统支持通过界面上的复选框灵活筛选要显示的年级（1-6年级）。默认显示全部 59 个知识点。

筛选流程：
1. 用户在左侧面板选择/取消选择年级
2. 调用 `applyGradeFilter()` 重新加载数据
3. 自动清理已掌握状态中不在当前筛选范围内的节点
4. 重新初始化图谱、UI 和可达矩阵

## 核心算法

### Warshall 算法计算传递闭包

```javascript
// 初始化邻接矩阵
let R = Array(n).fill(null).map(() => Array(n).fill(0));

// 填充直接边
edges.forEach(e => { R[nodeIndex[e.source]][nodeIndex[e.target]] = 1; });

// 自反性
for (let i = 0; i < n; i++) R[i][i] = 1;

// Warshall 核心
for (let k = 0; k < n; k++)
    for (let i = 0; i < n; i++)
        for (let j = 0; j < n; j++)
            R[i][j] = R[i][j] || (R[i][k] && R[k][j]);
```

### BFS 最短路径查找

`findPath(start, end)` 使用广度优先搜索找到两个知识点之间的最短学习路径。

## 界面布局

### 桌面端（三栏布局）
```
┌─────────────────────────────────────────────────────────────┐
│  顶部导航栏 (标题、节点统计、重置按钮)                          │
├──────────────┬──────────────────────────┬───────────────────┤
│              │                          │                   │
│   左侧控制    │      中间知识图谱         │     右侧矩阵       │
│   面板        │      (D3.js可视化)       │     (可达矩阵)     │
│              │                          │                   │
│  - 年级筛选   │                          │                   │
│  - 可达查询   │                          │                   │
│  - 多源分析   │                          │                   │
│  - 掌握模拟   │                          │                   │
│              │                          │                   │
└──────────────┴──────────────────────────┴───────────────────┘
```

### 移动端（标签切换）
底部标签栏切换三个面板：
- **控制面板**：年级筛选、可达查询、掌握模拟
- **知识图谱**：D3.js 力导向图可视化
- **可达矩阵**：传递闭包矩阵展示

## 功能模块

### 1. 可达性查询
选择起点和终点知识点，系统计算：
- 是否存在学习路径（基于可达矩阵）
- 最短路径（BFS算法）
- 路径长度和具体节点序列

### 2. 多源关联分析
选择多个已掌握的知识点，分析：
- 联合可达的新知识范围（并集）
- 可解锁的知识点数量和列表
- 自动高亮显示相关节点

### 3. 掌握状态模拟
提供快捷按钮模拟不同掌握水平：
- 掌握1年级：掌握所有1年级知识点
- 掌握2年级：掌握1-2年级知识点
- 仅基础：掌握无前置依赖的知识点
- 清空掌握：重置所有状态

### 4. 可达矩阵可视化
- 实时显示传递闭包矩阵
- 支持点击单元格查看详细信息
- 支持导出 CSV 文件
- 根据掌握状态动态高亮

## 运行与部署

### 本地运行

由于使用 CDN 引入依赖，直接打开文件即可：

```bash
# 方式1：直接打开文件
start index.html

# 方式2：使用本地服务器（推荐，避免跨域限制）
python -m http.server 8080
# 然后访问 http://localhost:8080
```

### 部署

静态文件托管即可，无需服务器端逻辑：
- GitHub Pages
- Vercel / Netlify
- Nginx / Apache

## 代码规范

### 命名约定

- **变量**：camelCase（如 `sourceNode`, `reachabilityMatrix`）
- **函数**：camelCase，动词开头（如 `initData`, `computeReachabilityMatrix`）
- **常量**：SCREAMING_SNAKE_CASE（项目暂无严格常量定义）
- **DOM ID**：kebab-case（如 `sourceSelect`, `queryResult`）

### 注释语言

所有注释和界面文本使用**简体中文**。

### 代码组织

- 全局变量声明在文件顶部
- 初始化函数：`initData()`, `initGraph()`, `initUI()`
- 事件处理函数通过 `onclick` 内联绑定在 HTML 中
- D3 相关代码集中在 `initGraph()` 和 `renderGraph()` 中

## 扩展指南

### 添加新知识点

在 `knowledgeData` 对象中添加新条目：

```javascript
"3-新知识点": { 
    grade: 3, 
    deps: ["3-前置知识1", "3-前置知识2"], 
    desc: "知识点描述" 
}
```

注意：如果前置知识不在当前筛选范围内（如只显示3年级），需要在 `initData()` 中调整筛选逻辑或确保前置知识也被包含。

### 修改筛选年级

在 `initData()` 函数中修改筛选条件：

```javascript
// 根据界面选择的年级筛选
const selectedGrades = getSelectedGrades(); // 返回选中的年级数组，如 [1,2,3]
nodes = nodes.filter(n => selectedGrades.includes(n.grade));
```

### 调整力导向图布局

在 `initGraph()` 中修改 D3 力模拟参数：

```javascript
simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(edges).id(d => d.id).distance(100))  // 连线距离
    .force('charge', d3.forceManyBody().strength(-300))              // 节点斥力
    .force('center', d3.forceCenter(width / 2, height / 2))          // 中心力
    .force('y', d3.forceY(d => 200 + (3 - d.grade) * 150).strength(0.3))  // 年级分层
    .force('collision', d3.forceCollide().radius(50));               // 碰撞检测
```

## 响应式设计

### 断点适配

| 断点 | 宽度 | 布局 |
|------|------|------|
| 移动端 | < 768px | 单列布局，底部标签切换 |
| 平板端 | 768px - 1024px | 双栏布局（控制面板 + 图谱/矩阵切换） |
| 桌面端 | > 1024px | 三栏完整布局 |

### 移动端优化

- **底部标签栏**：控制面板 / 知识图谱 / 可达矩阵 三个标签快速切换
- **简化图例**：节点状态使用更紧凑的展示
- **触摸优化**：按钮和复选框增大点击区域
- **字体缩放**：根据屏幕尺寸自动调整文字大小

## 已知限制

1. **硬编码数据**：知识点数据直接写在 `app.js` 中，无外部数据加载机制
2. **单文件架构**：所有逻辑集中在单个文件，规模扩大后建议模块化
3. **无持久化**：掌握状态在页面刷新后重置
4. **性能考虑**：当显示全部59个节点时，力导向图在低端设备上可能需要优化

## 浏览器兼容性

- Chrome / Edge 90+
- Firefox 88+
- Safari 14+

依赖现代 JavaScript 特性（如箭头函数、模板字符串、ES6 模块语法）。
